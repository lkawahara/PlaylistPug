package edu.neumont.java.playlistpug;

import java.io.File;
import java.io.IOException;
import java.util.Iterator;
import java.util.List;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.fileupload.FileItem;
import org.apache.commons.fileupload.FileItemFactory;
import org.apache.commons.fileupload.disk.DiskFileItemFactory;
import org.apache.commons.fileupload.servlet.ServletFileUpload;

/**
 * Servlet implementation class PugServlet
 */
@WebServlet("/pugs/*")
public class PugServlet extends HttpServlet {
	private static final long serialVersionUID = 1L;
    private String[] dummy = {"One","Two","Three","Four","Five"};
    private String rowOne = "";
    private String rowTwo = "";
    private String rowThree = "";
    /**
     * @see HttpServlet#HttpServlet()
     */
    public PugServlet() {
        super();
    }

	/**
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		String destination = request.getPathInfo();
		String[] path = null;
		String error = "You done goofed.";
		request.setAttribute("error", error);
		if(request.getPathInfo() == null || request.getPathInfo().equals("")){
			destination = "/WEB-INF/index.jsp";
		}else{
			path = request.getPathInfo().substring(1).split("/");
			
			if(destination.equals("/") || path[0].equals("index") || path[0].equals("main") || path[0].equals("home")){
				destination = "/WEB-INF/index.jsp";
			}else if(path[0].equals("upload")){
				destination = "/WEB-INF/upload.jsp";
			}else if(path[0].equals("song")){
				//set attributes name as the name of the song and
				//song as whatever is needed to play the song
				request.setAttribute("name", "song name");
				request.setAttribute("song", "song data");
				request.setAttribute("sid", 1);
				destination = "/WEB-INF/song.jsp";
			}else if(path[0].equals("search")){
				//depends on how we decide to do the searching
				//may set attribute to search terms or list of search results
				getResults();
				request.setAttribute("rowOne", rowOne);
				request.setAttribute("rowTwo", rowTwo);
				request.setAttribute("rowThree", rowThree);
				destination = "/WEB-INF/search.jsp";
			}else{
				destination = "/WEB-INF/error.jsp";
			}
		}
		RequestDispatcher rd = request.getRequestDispatcher(destination);
		rd.forward(request, response);
	}

	/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		String redirect = "";
		String p = request.getPathInfo().substring(1);
		String[] path = p.split("/");	
		if(path[1].equals("upload") && path.length == 2){
			redirect = "/pugs/upload";
			
			FileItemFactory factory = new DiskFileItemFactory();
			ServletFileUpload upload = new ServletFileUpload(factory);
			String uploadFolder = getServletContext().getRealPath("")
	                + File.separator + "resources";
			 try {
		            // Parse the request
		            List items = upload.parseRequest(request);
		            Iterator iter = items.iterator();
		            while (iter.hasNext()) {
		                FileItem item = (FileItem) iter.next();

		                if (!item.isFormField()) {
		                    String fileName = new File(item.getName()).getName();
		                    String filePath = uploadFolder + File.separator + fileName;
		                    File uploadedFile = new File(filePath);
		                    System.out.println(filePath);
		                    // saves the file to upload directory
		                    item.write(uploadedFile);
		                }
		            }

		            // displays done.jsp page after upload finished
		            getServletContext().getRequestDispatcher("/done.jsp").forward(
		                    request, response);

		        } catch (FileUploadException ex) {
		            throw new ServletException(ex);
		        } catch (Exception ex) {
		            throw new ServletException(ex);
		        }


	
			
		}else if(path[1].equals("nextSong") && path.length == 2){
			redirect = "/pugs/song/1";
		}else if(path[1].equals("search") && path.length == 3){
			redirect = "/pugs/search";
		}
		response.sendRedirect(redirect);
		

	}
	private void getResults(){
		int rounds = dummy.length / 3;
		rowOne = "";
		rowTwo = "";
		if(dummy.length % 3 == 0){
			for(int i = 0; i < rounds; i++){
				rowOne += "<a href='/pugs/home'>" + dummy[i] + "</a>";
			}
			for(int i = 0; i < rounds; i++){
				rowTwo += "<a href='/pugs/home'>" + dummy[rounds + i] + "</a>";
			}
			for(int i = 0; i < rounds; i++){
				rowThree += "<a href='/pugs/home'>" + dummy[(rounds * 2) + i] + "</a>";
			}
		}else if(dummy.length % 3 == 1){
			for(int i = 0; i < rounds; i++){
				rowOne += "<a href='/pugs/home'>" + dummy[i] + "</a>";
			}
			for(int i = 0; i < rounds; i++){
				rowTwo += "<a href='/pugs/home'>" + dummy[rounds + i] + "</a>";
			}
			for(int i = 0; i < rounds; i++){
				rowThree += "<a href='/pugs/home'>" + dummy[(rounds * 2) + i] + "</a>";
			}
			rowOne += "<a href='/pugs/home'>" + dummy[dummy.length - 1] + "</a>";
		}else{
			for(int i = 0; i < rounds; i++){
				rowOne += "<a href='/pugs/home'>" + dummy[i] + "</a>";
			}
			for(int i = 0; i < rounds; i++){
				rowTwo += "<a href='/pugs/home'>" + dummy[rounds + i] + "</a>";
			}
			for(int i = 0; i < rounds; i++){
				rowThree += "<a href='/pugs/home'>" + dummy[(rounds * 2) + i] + "</a>";
			}
			rowOne += "<a href='/pugs/home'>" + dummy[dummy.length - 1] + "</a>";
			rowTwo += "<a href='/pugs/home'>" + dummy[dummy.length - 2] + "</a>";
		}
		
	}
}
